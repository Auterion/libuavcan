<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>libuavcan: Libuavcan Build and Test Automation</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <link href="customdoxygen.css" rel="stylesheet" type="text/css" />
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
        <script type="text/javascript" src="jquery.smartmenus.js"></script>
        <!-- SmartMenus jQuery Bootstrap Addon -->
        <script type="text/javascript" src="jquery.smartmenus.bootstrap.js"></script>
        <!-- SmartMenus jQuery plugin -->
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="https://uavcan.org"><img src="uavcan_logo.svg" style="float:left;height:1.5em;padding:0em .5em .25em 0em;"/> libuavcan</a>
                    <em><a class="navbar-brand" href="https://buildkite.com/uavcan/libuavcan-v1/builds/77" style="font-size: .75em; color: coral">build:77</a></em>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Libuavcan Build and Test Automation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Pi worker</h2>
<h3>Hardware</h3>
<ol type="1">
<li><a href="https://www.newark.com/raspberry-pi/rpi3-modbp/sbc-arm-cortex-a53-1gb-sdram/dp/49AC7637">Rasberry PI 3 B+</a> with 3A power supply.</li>
<li>16GB SDHC class 4 card.</li>
</ol>
<h3>Software</h3>
<p>Raspbian Stretch Lite</p>
<ul>
<li>Version:April 2019</li>
<li>Release date:2019-04-08</li>
<li>Kernel version:4.14</li>
<li>SHA-256: 03ec326d45c6eb6cef848cf9a1d6c7315a9410b49a276a6b28e67a40b11fdfcf</li>
</ul>
<h3>Post Install Steps</h3>
<div class="fragment"><div class="line">sudo raspi-config</div></div><!-- fragment --><ol type="1">
<li>Change the default password. Keep this password to yourself.</li>
<li>Enable SSH</li>
<li>Expand the filesystem to use the entire SD card.</li>
<li>Change the hostname to something useful and unique (this will appear as the agent name in buildkite. It must be changed from the default).</li>
</ol>
<div class="fragment"><div class="line">sudo apt update</div><div class="line">sudo apt upgrade -y</div><div class="line">sudo apt install git</div><div class="line">sudo apt install -y python3-pip</div><div class="line">git clone https://github.com/thirtytwobits/nanaimo.git</div><div class="line">cd nanaimo</div><div class="line">pip3 install --system .</div></div><!-- fragment --><h4><a href="https://www.segger.com/downloads/jlink">Segger JLink</a></h4>
<p>Download the J-Link software for Linux ARM systems.</p>
<div class="fragment"><div class="line">scp path/to/JLink_Linux_VXXX_arm.tgz pi@[ip address]:~</div><div class="line">ssh pi@[ip address]</div><div class="line">tar -xvf JLink_Linux_VXXX_arm.tgz</div><div class="line">mv JLink_Linux_VXXX_arm /opt/</div><div class="line">cd /opt/JLink_Linux_VXXX_arm</div><div class="line">sudo cp 99-jlink.rules /etc/udev/rules.d/</div><div class="line">sudo ln -s /opt/JLink_Linux_VXXX_arm/JLinkExe /bin/JLinkExe</div></div><!-- fragment --><p> modify <code>/boot/config.txt</code> adding the following:</p>
<div class="fragment"><div class="line">max_usb_current=1</div></div><!-- fragment --><p>and restart.</p>
<div class="fragment"><div class="line">sudo shutdown -r now</div></div><!-- fragment --><h4>Build Kite Agent</h4>
<p>(taken from the <a href="https://buildkite.com/docs/agent/v3/debian">buildkit agent for Debian instructions</a>)</p>
<div class="fragment"><div class="line"># Add the buildkit repo</div><div class="line">sudo apt-get install -y apt-transport-https dirmngr</div><div class="line">sudo apt-key adv --keyserver ipv4.pool.sks-keyservers.net --recv-keys 32A37959C2FA5C3C99EFBC32A79206696452D198</div><div class="line">ssh-keygen -t rsa -b 4096 -C &quot;[hostname]@uavcan.org&quot;</div><div class="line">&quot;echo deb https://apt.buildkite.com/buildkite-agent stable main&quot; | sudo tee /etc/apt/sources.list.d/buildkite-agent.list</div><div class="line"></div><div class="line"># Install the Agent</div><div class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y buildkite-agent</div></div><!-- fragment --><p>At this point you'll need to obtain a worker token from a member of the uavcan organization. We will generate a token that is for your fleet of pi's only and reserve the right to revoke that key if we feel your workers are misbehaving.</p>
<p>Buildkite administators: see <a href="https://forum.buildkite.community/t/multiple-agent-tokens-per-org-with-agent-queue-restrictions/143/3">this post</a> for how to generate a new token.</p>
<p>Once you have this token you can complete the agent installation:</p>
<div class="fragment"><div class="line"># Add the libuavcan token</div><div class="line">sudo sed -i &quot;s/xxx/INSERT-YOUR-AGENT-TOKEN-HERE/g&quot; /etc/buildkite-agent/buildkite-agent.cfg</div><div class="line"></div><div class="line"># Start the service</div><div class="line">sudo systemctl enable buildkite-agent &amp;&amp; sudo systemctl start buildkite-agent</div></div><!-- fragment --><p>You can tail the logs using journalctl:</p>
<div class="fragment"><div class="line">sudo journalctl -f -u buildkite-agent</div></div><!-- fragment --><p>Allow the agent to use serial devices:</p>
<div class="fragment"><div class="line">usermod -a -G dialout buildkite-agent</div></div><!-- fragment --><h4>Hooks</h4>
<p>We setup bespoke PI workers which allows us to avoid key management issues for these devices since they do not need access to the source. The first thing is to tell buildkite <em>not</em> to pull source. This is accomplished using the technique documented in <a href="https://github.com/buildkite/agent/pull/909">this pull request</a>. Namely, empty the <code>BUILDKITE_REPO</code> variable in the <code>environment</code> hook under <code>/etc/buildkite-agent/hooks</code>:</p>
<div class="fragment"><div class="line">cd /etc/buildkite-agent/hooks</div><div class="line">mv environment.sample environment</div><div class="line">mv command.sample command</div></div><!-- fragment --><p>Sudo edit the <code>environment</code> file and change it to:</p>
<div class="fragment"><div class="line">set -eu</div><div class="line">echo &#39;--- :strawberry: Setting up a no-source environment for raspberry pi.&#39;</div><div class="line"></div><div class="line">export BUILDKITE_REPO=</div></div><!-- fragment --><p>(vote for <a href="https://forum.buildkite.community/t/emoji/533">this feature request</a> to get a :raspberry: emoji added to buildkite.)</p>
<p>Sudo edit the <code>command</code> file and change it to:</p>
<div class="fragment"><div class="line">#!/usr/bin/env bash</div><div class="line"></div><div class="line"># +----------------------------------------------------------+</div><div class="line"># | BASH : Modifying Shell Behaviour</div><div class="line"># |    (https://www.gnu.org/software/bash/manual)</div><div class="line"># +----------------------------------------------------------+</div><div class="line"># Treat unset variables and parameters other than the special</div><div class="line"># parameters ‘@’ or ‘*’ as an error when performing parameter</div><div class="line"># expansion. An error message will be written to the standard</div><div class="line"># error, and a non-interactive shell will exit.</div><div class="line">set -o nounset</div><div class="line"></div><div class="line"># Exit immediately if a pipeline returns a non-zero status.</div><div class="line">set -o errexit</div><div class="line"></div><div class="line"># If set, the return value of a pipeline is the value of the</div><div class="line"># last (rightmost) command to exit with a non-zero status, or</div><div class="line"># zero if all commands in the pipeline exit successfully.</div><div class="line">set -o pipefail</div><div class="line"></div><div class="line"># +----------------------------------------------------------+</div><div class="line"># | This script is one of the common set of commands run as</div><div class="line"># | part of a continuous integration build pipeline.</div><div class="line"># | These scrips are named using the following scheme:</div><div class="line"># |</div><div class="line"># |   [build_type]-[(optional)build_type qualifier]-[build|test|report|upload].sh</div><div class="line"># |</div><div class="line"># | Of course, libuavcan is a header-only distribution so</div><div class="line"># | CI is used to verify and test rather than package and</div><div class="line"># | deploy (i.e. There&#39;s really no &#39;I&#39; going on).</div><div class="line"># +----------------------------------------------------------+</div><div class="line">mkdir -p build_ci_ontarget_s32k</div><div class="line">pushd build_ci_ontarget_s32k</div><div class="line"></div><div class="line">buildkite-agent artifact download &quot;build_ci_ontarget_s32k/*.hex&quot; .</div><div class="line">buildkite-agent artifact download &quot;build_ci_ontarget_s32k/*.jlink&quot; .</div><div class="line">ls -lAh</div><div class="line"></div><div class="line">nait -vv \</div><div class="line">     --port \</div><div class="line">     /dev/serial/by-id/usb-Signoid_Kft._USB-UART_adapter_MACX98-if00-port0 \</div><div class="line">     --port-speed 115200 \</div><div class="line">     \*.jlink</div><div class="line"></div><div class="line">popd</div></div><!-- fragment --><p>where the serial port is the one connected to the S32K dev kit. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/>
</body>
        <script type="text/javascript" src="doxy-boot.js"></script>
</html>
