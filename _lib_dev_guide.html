<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>libuavcan: Libuavcan Library Developer Guide</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <link href="customdoxygen.css" rel="stylesheet" type="text/css" />
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
        <script type="text/javascript" src="jquery.smartmenus.js"></script>
        <!-- SmartMenus jQuery Bootstrap Addon -->
        <script type="text/javascript" src="jquery.smartmenus.bootstrap.js"></script>
        <!-- SmartMenus jQuery plugin -->
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="https://uavcan.org"><img src="uavcan_logo.svg" style="float:left;height:1.5em;padding:0em .5em .25em 0em;"/> libuavcan</a>
                    <em><a class="navbar-brand" href="https://buildkite.com/uavcan/libuavcan-v1/builds/172" style="font-size: .75em; color: coral">build:172</a></em>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Libuavcan Library Developer Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p>This is a guide for developers of libuavcan itself. If you are a user of libuavcan you don't need to read this, but hey; Thanks for using our software. </p>
</blockquote>
<hr/>
<blockquote class="doxtable">
<p>And now...on to the sausage making! </p>
</blockquote>
<h2>Build System</h2>
<p>We require <a href="https://cmake.org/cmake/help/v3.6/">cmake 3.6</a> or greater because that's what Ubuntu 18.04 ships with and Ubuntu 18.04 is the reference operating system we use as our generic build and test environment. At the time of this writing we have only tested the GNU Makefile generator but there's no reason why ninja shouldn't work either.</p>
<p>The default cmake setup and build should always work:</p>
<div class="fragment"><div class="line">mkdir build</div><div class="line">cd build</div><div class="line">cmake ..</div><div class="line">make -j8 &amp;&amp; echo &quot;this is fine.&quot;</div></div><!-- fragment --><p>To run the same commands as the automated builds use the scripts under the <code>ci/</code> folder. These create subdirectories under the project root folder using the following rules:</p>
<div class="fragment"><div class="line">build_{build_type}_{build_type qualifier}</div><div class="line">build_ext_{build_type}_{build_type qualifier}</div></div><!-- fragment --><p>For example: </p><div class="fragment"><div class="line">./ci/native-gcc-build-and-test.sh</div><div class="line"># will create and build using two directories</div><div class="line">build_native_gcc</div><div class="line">build_ext_native_gcc</div></div><!-- fragment --><p>The naming for these files and the folders they create follow this pattern:</p>
<div class="fragment"><div class="line">[build_type]-[(optional)build_type qualifier]-[build|test|report|upload].sh</div></div><!-- fragment --><p>Because of these rules, you can super-clean your package directory with <code>rm -rf build*</code> (or <code>git rm -dfx</code> but that will also blow away other things you might still want).</p>
<h3>build_ext</h3>
<p>build_ext in folder prefixes stands for "external build". The cmake build will pull some dependencies from the internet including from github (for googletest) and Pypi. These downloads and the builds for these downloaded projects are stored under this "ext" folder. If you <code>rm -rf</code> just the build directory you can recreate and build without downloading anything again.</p>
<h3>CMAKE_BUILD_TYPE</h3>
<p><code>Debug</code> enables introspection options by default. This should be enabled for at least one ci build and disabled for at least one other ci build. Any explicit introspection defines are not effected by the build type. See <a class="el" href="libuavcan_8hpp.html">libuavcan/libuavcan.hpp</a> for more details.</p>
<h2>Developer Environment</h2>
<blockquote class="doxtable">
<p><b>TODO</b> (hint: it'll be about vscode since it's good and it's free) </p>
</blockquote>
<h2>OSX</h2>
<p>Where we use linux SocketCAN for examples you will need to build and run on a linux machine. To make this easier on OSX developers we provide a <a href="https://www.vagrantup.com/">Vagrantfile</a> in this document that pulls an Ubuntu image for <a href="https://www.virtualbox.org/">VirtualBox</a> which has the SocketCAN kernel modules and can-utils installed. This image is maintained by <a href="https://app.vagrantup.com/thirtytwobits/boxes/libuavcan_v1">thirtytwobits</a> so it's not necessarily part of the libuavcan toolchain but it should work. After you provision this image (i.e. <code>vagrant up</code>) you can attach USB <a class="el" href="namespace_c_a_n.html">CAN</a> probes directly to it or you can setup <code>vcan</code> links which will allow the libuavcan linux examples to run normally.</p>
<p>Note that there is currently a problem with cloning repositories on virtualbox shared directories. If you are using a virtualbox Vagrant provider you'll need to locate the external build directory outside of the share. You can use <code>-DLIBUAVCAN_EXT_FOLDER=/home/vagrant/libuavcan_build_ext</code> when you configure, for example.</p>
<h3>Vagrantfile</h3>
<div class="fragment"><div class="line"># -*- mode: ruby -*-</div><div class="line"># vi: set ft=ruby :</div><div class="line"></div><div class="line"># We use docker as our reference build environment but this Vagrant file is handy</div><div class="line"># if you need to test real SocketCAN devices on OSX.</div><div class="line">Vagrant.configure(&quot;2&quot;) do |config|</div><div class="line"></div><div class="line">    config.vm.box = &quot;thirtytwobits/libuavcan_v1&quot;</div><div class="line">    config.vm.box_version = &quot;1.0&quot;</div><div class="line"></div><div class="line">    config.vm.provider :virtualbox do |v|</div><div class="line">      v.customize [ &quot;guestproperty&quot;, &quot;set&quot;, :id, &quot;/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold&quot;, 10000 ]</div><div class="line">    end</div><div class="line">    config.vm.provision &quot;shell&quot; do |s|</div><div class="line">      s.inline = &lt;&lt;-SCRIPT</div><div class="line">        # Change directory automatically on ssh login</div><div class="line">        echo &quot;export CXX=\&quot;g++-7\&quot; CC=\&quot;gcc-7\&quot;&quot; &gt;&gt; /home/vagrant/.bashrc</div><div class="line">        echo &quot;cd    /vagrant&quot; &gt;&gt; /home/vagrant/.bashrc</div><div class="line">      SCRIPT</div><div class="line">    end</div><div class="line">  end</div></div><!-- fragment --><p>or just do:</p>
<div class="fragment"><div class="line">vagrant init thirtytwobits/libuavcan_v1 --box-version 1.0</div><div class="line">vagrant up</div></div><!-- fragment --><h3>Vagrant Cheatsheet</h3>
<div class="fragment"><div class="line">vagrant up</div><div class="line">vagrant ssh</div></div><!-- fragment --><p>Attach a <a class="el" href="namespace_c_a_n.html">CAN</a> probe to the guest using VBoxManage:</p>
<div class="fragment"><div class="line"># first, find your vagrant guest.</div><div class="line">VBoxManage list vms</div><div class="line"></div><div class="line"># next, find the UUID of the usb device on the host. In this example</div><div class="line"># we look for a PCAN probe:</div><div class="line">VBoxManage list usbhost | grep --context=7 PCAN</div><div class="line"></div><div class="line"># now, attach the usb device to the guest.</div><div class="line">VBoxManage controlvm my_libuavcan_vagrant_guest_3249032840 usbattach a2d153de-63f1-411d-08d2-eefc42b792fa</div><div class="line"></div><div class="line"># You can also setup a filter so this device will be auto-captured:</div><div class="line">VBoxManage usbfilter add 0 --target my_libuavcan_vagrant_guest_3249032840 --name PEAK --action hold --product &quot;PCAN-USB Pro FD&quot;</div></div><!-- fragment --><h2>Linux</h2>
<blockquote class="doxtable">
<p>TODO: document common SocketCAN setups for running linux examples. </p>
</blockquote>
<h1><a class="anchor" id="LibCIGuide"></a>
Libuavcan Library Developer Continuous Integration </h1>
<blockquote class="doxtable">
<p>TODO buildkite documentation </p>
</blockquote>
<h2>Pi worker</h2>
<h3>Hardware</h3>
<ol type="1">
<li><a href="https://www.newark.com/raspberry-pi/rpi3-modbp/sbc-arm-cortex-a53-1gb-sdram/dp/49AC7637">Rasberry PI 3 B+</a> with 3A power supply.</li>
<li>16GB SDHC class 4 card.</li>
</ol>
<h3>Software</h3>
<p>Raspbian Buster Lite</p>
<ul>
<li>Version: June 2019</li>
<li>Release date: 2019-06-20</li>
<li>Kernel version: 4.19</li>
<li>SHA-256: 9009409a9f969b117602d85d992d90563f181a904bc3812bdd880fc493185234</li>
</ul>
<h3>Post Install Steps</h3>
<h4>raspi-config</h4>
<div class="fragment"><div class="line">sudo raspi-config</div></div><!-- fragment --><ol type="1">
<li>Change the default password. Keep this password to yourself.</li>
<li>Enable SSH</li>
<li>Expand the filesystem to use the entire SD card.</li>
<li>Change the hostname to something useful and unique (this will appear as the agent name in buildkite. It must be changed from the default).</li>
</ol>
<h4>security</h4>
<p>Some hardening steps.</p>
<div class="fragment"><div class="line">cd /etc/sysctl.d</div><div class="line">sudo vi 98-rpi.conf</div></div><!-- fragment --><p>In 98-rpi.conf add:</p>
<div class="fragment"><div class="line">fs.protected_hardlinks = 1</div><div class="line">fs.protected_symlinks = 1</div></div><!-- fragment --><p>then reboot.</p>
<h4>Software</h4>
<div class="fragment"><div class="line">sudo apt update</div><div class="line">sudo apt upgrade -y</div><div class="line">sudo apt install -y vim</div><div class="line">sudo apt install -y git</div><div class="line">sudo apt install -y python3-pip</div><div class="line">sudo apt install -y can-utils</div><div class="line">git clone https://github.com/thirtytwobits/nanaimo.git</div><div class="line">cd nanaimo</div><div class="line">sudo pip3 install --system .</div><div class="line">echo &quot;alias la=&#39;ls -lah&#39;&quot; | sudo tee -a /etc/bash.bashrc</div></div><!-- fragment --><h4><a class="el" href="namespace_c_a_n.html">CAN</a></h4>
<p>Load vcan on boot:</p>
<div class="fragment"><div class="line">echo vcan | sudo tee -a /etc/modules</div></div><!-- fragment --><p>Configure vcan0, and if using a can adapter, can0 on boot:</p>
<div class="fragment"><div class="line">sudo vi /etc/network/interfaces.d/can</div></div><!-- fragment --><div class="fragment"><div class="line">auto vcan0</div><div class="line">    iface vcan0 inet manual</div><div class="line">    pre-up /sbin/ip link add dev $IFACE type vcan</div><div class="line">    up /sbin/ifconfig $IFACE up</div><div class="line"></div><div class="line">auto can0</div><div class="line">    iface can0 inet manual</div><div class="line">    pre-up /sbin/ip link set $IFACE type can bitrate 1000000 dbitrate 2000000 fd on sample-point .8 dsample-point .8 berr-reporting off fd-non-iso off restart-ms 100</div><div class="line">    up /sbin/ifconfig $IFACE up</div><div class="line">    down /sbin/ifconfig $IFACE down</div></div><!-- fragment --><h4><a href="https://www.segger.com/downloads/jlink">Segger JLink</a></h4>
<p>Download the J-Link software for Linux ARM systems.</p>
<div class="fragment"><div class="line">scp path/to/JLink_Linux_VXXX_arm.tgz pi@[ip address]:~</div><div class="line">ssh pi@[ip address]</div><div class="line">tar -xvf JLink_Linux_VXXX_arm.tgz</div><div class="line">sudo mv JLink_Linux_VXXX_arm /opt/</div><div class="line">cd /opt/JLink_Linux_VXXX_arm</div><div class="line">sudo cp 99-jlink.rules /etc/udev/rules.d/</div><div class="line">sudo ln -s /opt/JLink_Linux_VXXX_arm/JLinkExe /bin/JLinkExe</div></div><!-- fragment --><p> modify <code>/boot/config.txt</code> adding the following:</p>
<div class="fragment"><div class="line">max_usb_current=1</div></div><!-- fragment --><p>and restart.</p>
<div class="fragment"><div class="line">sudo shutdown -r now</div></div><!-- fragment --><p>Another compelling solution is the <a href="https://1bitsquared.com/products/black-magic-probe">Black Magic Probe</a> but I haven't had time to try using this with the PI/NXP setup. I will try to write a section on how to use this probe in the future.</p>
<h4>Build Kite Agent</h4>
<p>(taken from the <a href="https://buildkite.com/docs/agent/v3/debian">buildkit agent for Debian instructions</a>)</p>
<div class="fragment"><div class="line"># Add the buildkit repo</div><div class="line">sudo apt-get install -y apt-transport-https dirmngr</div><div class="line">sudo apt-key adv --keyserver ipv4.pool.sks-keyservers.net --recv-keys 32A37959C2FA5C3C99EFBC32A79206696452D198</div><div class="line">ssh-keygen -t rsa -b 4096 -C &quot;[hostname]@uavcan.org&quot;</div><div class="line">echo &quot;deb https://apt.buildkite.com/buildkite-agent stable main&quot; | sudo tee /etc/apt/sources.list.d/buildkite-agent.list</div><div class="line"></div><div class="line"># Install the Agent</div><div class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y buildkite-agent</div></div><!-- fragment --><p>At this point you'll need to obtain a worker token from a member of the uavcan organization. We will generate a token that is for your fleet of pi's only and reserve the right to revoke that key if we feel your workers are misbehaving.</p>
<p>Buildkite administators: see <a href="https://forum.buildkite.community/t/multiple-agent-tokens-per-org-with-agent-queue-restrictions/143/3">this post</a> for how to generate a new token.</p>
<p>Once you have this token you can complete the agent installation:</p>
<div class="fragment"><div class="line"># Add the libuavcan token</div><div class="line">sudo sed -i &quot;s/xxx/INSERT-YOUR-AGENT-TOKEN-HERE/g&quot; /etc/buildkite-agent/buildkite-agent.cfg</div></div><!-- fragment --><p>Edit the config with the proper tags </p><div class="fragment"><div class="line">sudo vi /etc/buildkite-agent/buildkite-agent.cfg</div></div><!-- fragment --><p>uncomment "tags" and set with the proper queue tags (e.g. <code>tags="queue=ontarget-s32k"</code>)</p>
<p>Finally, start the service. </p><div class="fragment"><div class="line"># Start the service</div><div class="line">sudo systemctl enable buildkite-agent &amp;&amp; sudo systemctl start buildkite-agent</div></div><!-- fragment --><p>You can tail the logs using journalctl:</p>
<div class="fragment"><div class="line">sudo journalctl -f -u buildkite-agent</div></div><!-- fragment --><p>Allow the agent to use serial devices:</p>
<div class="fragment"><div class="line">sudo usermod -a -G dialout buildkite-agent</div></div><!-- fragment --><h4>Hooks</h4>
<p>We setup bespoke PI workers which allows us to avoid key management issues for these devices since they do not need access to the source. The first thing is to tell buildkite <em>not</em> to pull source. This is accomplished using the technique documented in <a href="https://github.com/buildkite/agent/pull/909">this pull request</a>. Namely, empty the <code>BUILDKITE_REPO</code> variable in the <code>environment</code> hook under <code>/etc/buildkite-agent/hooks</code>:</p>
<div class="fragment"><div class="line">cd /etc/buildkite-agent/hooks</div><div class="line">sudo mv environment.sample environment</div><div class="line">sudo mv command.sample command</div></div><!-- fragment --><p>Sudo edit the <code>environment</code> file and change it to:</p>
<div class="fragment"><div class="line">set -eu</div><div class="line">echo &#39;--- :raspberry-pi: Setting up a no-source environment for raspberry pi.&#39;</div><div class="line"></div><div class="line"># Empty value prevents source cloning. The workers don&#39;t have access to source.</div><div class="line">export BUILDKITE_REPO=</div></div><!-- fragment --><p>Sudo edit the <code>command</code> file and change it to:</p>
<div class="fragment"><div class="line">#!/usr/bin/env bash</div><div class="line"></div><div class="line"># +----------------------------------------------------------+</div><div class="line"># | BASH : Modifying Shell Behaviour</div><div class="line"># |    (https://www.gnu.org/software/bash/manual)</div><div class="line"># +----------------------------------------------------------+</div><div class="line"># Treat unset variables and parameters other than the special</div><div class="line"># parameters ‘@’ or ‘*’ as an error when performing parameter</div><div class="line"># expansion. An error message will be written to the standard</div><div class="line"># error, and a non-interactive shell will exit.</div><div class="line">set -o nounset</div><div class="line"></div><div class="line"># Exit immediately if a pipeline returns a non-zero status.</div><div class="line">set -o errexit</div><div class="line"></div><div class="line"># If set, the return value of a pipeline is the value of the</div><div class="line"># last (rightmost) command to exit with a non-zero status, or</div><div class="line"># zero if all commands in the pipeline exit successfully.</div><div class="line">set -o pipefail</div><div class="line"></div><div class="line"># +----------------------------------------------------------+</div><div class="line"># | This script is one of the common set of commands run as</div><div class="line"># | part of a continuous integration build pipeline.</div><div class="line"># | These scrips are named using the following scheme:</div><div class="line"># |</div><div class="line"># |   [build_type]-[(optional)build_type qualifier]-[build|test|report|upload].sh</div><div class="line"># |</div><div class="line"># | Of course, libuavcan is a header-only distribution so</div><div class="line"># | CI is used to verify and test rather than package and</div><div class="line"># | deploy (i.e. There&#39;s really no &#39;I&#39; going on).</div><div class="line"># +----------------------------------------------------------+</div><div class="line">mkdir -p build_ontarget_s32k</div><div class="line">pushd build_ontarget_s32k</div><div class="line"></div><div class="line">buildkite-agent artifact download &quot;build_ontarget_s32k/*.hex&quot; .</div><div class="line">buildkite-agent artifact download &quot;build_ontarget_s32k/*.jlink&quot; .</div><div class="line">ls -lAh</div><div class="line"></div><div class="line">nait -vv \</div><div class="line">     --port \</div><div class="line">     /dev/serial/by-id/usb-Signoid_Kft._USB-UART_adapter_MACX98-if00-port0 \</div><div class="line">     --port-speed 115200 \</div><div class="line">     --test-timeout-seconds 300 \</div><div class="line">     \*.jlink</div><div class="line"></div><div class="line">popd</div></div><!-- fragment --><p>where the serial port is the one connected to the S32K dev kit.</p>
<h3><a class="el" href="namespace_c_a_n.html">CAN</a></h3>
<p>To enable SocketCAN testing you should create a single <code>vcan0</code> interface on boot:</p>
<ol type="1">
<li>edit <code>/etc/modules</code> and add vcan</li>
<li>create and add the following to <code>/etc/network/interfaces.d/vcan0</code></li>
</ol>
<div class="fragment"><div class="line">auto vcan0</div><div class="line">   iface vcan0 inet manual</div><div class="line">   pre-up /sbin/ip link add dev $IFACE type vcan</div><div class="line">   up /sbin/ifconfig $IFACE up</div></div><!-- fragment --><p>Restart the worker and do <code>ifconfig</code> when it comes back to to verify you have setup vcan0.</p>
<h3>Other PI stuff</h3>
<h4>Adafruit Display</h4>
<p>I use an <a href="https://www.adafruit.com/product/2232">800x480 Adafruit LCD</a> for emergency, local access to PIs in my farm. This display requires hat the resolution is set specifically to 800x480 since it does not contain a video scaler. See <a href="https://learn.adafruit.com/adafruit-5-800x480-tft-hdmi-monitor-touchscreen-backpack/raspberry-pi-config">This tutorial</a> for details.</p>
<h4>SSH</h4>
<p>If you are getting: </p><div class="fragment"><div class="line">Received disconnect from [ip address] port 22:2: Too many authentication failures</div></div><!-- fragment --><p>Then ssh is trying to use an invalid key. Force password login as such:</p>
<div class="fragment"><div class="line">ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no pi@[ip address]</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<address class="footer-copyright"><small>
  <a href="https://uavcan.org">UAVCAN</a>
  – Copyright (C) 2014-1029 Pavel Kirienko <pavel.kirienko@gmail.com>
  – Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved
  – This documentation is provided under the MIT licence as part of the <a href="https://github.com/UAVCAN/libuavcan/blob/master/LICENSE">libuavcan project</a>.
  </small></address>
</body>
        <script type="text/javascript" src="doxy-boot.js"></script>
</html>
